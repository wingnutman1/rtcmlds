@model IEnumerable<CMS_Web.Models.RosterModel>

@{
    ViewBag.Title = "My Roster";
}


@(Html.Kendo().Notification()
    .Name("popupNotification")
)

<h2 class="dataHeader" , id="divNoUser">
    My Roster
</h2>

@using (Html.BeginForm())
{

    <div id="vertical">
        @(Html.Kendo().Scheduler<CMS_Web.Models.RosterModel>()
                .Name("scheduler")
                .Editable(true)
                .Height(600)
                .MajorTick(120)
                .DataSource(dataSource => dataSource
                    .ServerOperation(true)
                    .Read(read => read.Action("getMyRosters", "Roster").Data("getRosterParams")
                    )
                )
                .Views(views =>
                {
                    views.DayView(d => d.DateHeaderTemplate("<span class='k-link k-nav-day'>#=kendo.toString(date, 'ddd dd/M')#</span>"));
                    views.WeekView(weekView =>
                    {
                        weekView.Selected(true);
                        weekView.DateHeaderTemplate("<span class='k-link k-nav-day'>#=kendo.toString(date, 'ddd dd/M')#</span>");
                    });

                    views.MonthView();
                    views.AgendaView();
                })

        )

        </div>

}

<style scoped>
    #vertical {
        height: 600px;
        width: 1000px;
        margin: 0 auto;
        margin-bottom: 50px;
    }
</style>

<!--Reference the SignalR library. -->
<script src="/Scripts/jquery.signalR-2.1.2.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="/signalr/hubs"></script>
 
<script>

    function getRosterParams() {
        
        var scheduler = $("#scheduler").data("kendoScheduler");
        var view = scheduler.view();
        var startDate = view.startDate().toISOString();
        var finishDate = view.endDate().toISOString();

        return {
            userID: @WebSecurity.CurrentUserId,
            start: startDate,
            finish: finishDate
        };
    }

    $(document).ready(function () {


        var messageHub = $.connection.messageHub;
        var userName = "@HttpContext.Current.User.Identity.Name";

        $.connection.hub.qs = { 'userName': userName };
        var popupNotification = $("#popupNotification").data("kendoNotification");

        if ($.connection.hub.state === $.signalR.connectionState.disconnected) {
            $.connection.hub.start().done(function () {//when the connection is ready,

                popupNotification.show("Server Connection Established");
            });
        }

        messageHub.client.send = function (message) {
            if (message.messageType == "PM")
                popupNotification.show(message.message);
        };


    });

</script>

