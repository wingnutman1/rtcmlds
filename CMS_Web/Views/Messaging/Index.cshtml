
@model CMS_Web.Models.MessagingViewModel



@{
    ViewBag.Title = "Messages";
}


@(Html.Kendo().Notification()
    .Name("popupNotification")
)

<h2 class="dataHeader", id="divProcessing">
    Retrieving Messages, please wait . . . <img src="../../Images/ajax-loader.gif">
</h2>
  
<h2 class="dataHeader", id="divResult">
    Messages
</h2>

<h2 class="dataHeader", id="divNoUser">
    Messages
</h2>

@using (Html.BeginForm())
{

    <div id="vertical">
        <div id="top-pane">
            <div id="horizontal" style="height: 100%; width: 100%;">
                <div id="left-pane">
                        <div class="messagesUserList">
                                    
                            @(Html.Kendo().ListView<CMS_Web.Models.MessagingViewModel>()
                                .Name("StaffList")
                                .TagName("div")
                                .Navigatable()
                                .Pageable()
                                .ClientTemplateId("template")
                                .Selectable(select => select.Mode(ListViewSelectionMode.Multiple))
                                .DataSource(dataSource => dataSource
                                    .Read(read => read.Action("getStaff", "Messaging")
                                    )
                                )
                                .Events(e => e
                                    .Change("onUserSelect")
                                )

                            )
                            
                        </div>
                    </div>                        
                <div id="right-pane">
                    @{if (Model.displayMessages != null)
                        {
                            if (Model.displayMessages.Messages.Count != 0)
                            {                 
                                Html.Partial("~/Views/Shared/_Messages.cshtml", Model.displayMessages);
                            }
                            else
                            {
                                <p>No User Selected</p>
                            }
                        }
                        else
                        {
                        <P>No User Selected</P>
                        } 
                    }
                </div>
            </div>
        </div>
                
        <div id="bottom-pane">
            <div class="pane-content">
                    <h3>New Message</h3>
                    <p>
                        @Html.TextBoxFor(m => m.newMessage, new { style = "width:800px;" , id="messageText"})
                        <button id="btnNewMessage">Send</button>
                    </p>
                
            </div>
        </div>
    </div>
    
}




 

    <style scoped>
        #vertical {
            height: 600px;
            width: 1000px;
            margin: 0 auto;
        }

        .rootfolder { background-position: 0 0; }
        .folder { background-position: 0 -16px; }
        .pdf { background-position: 0 -32px; }
        .html { background-position: 0 -48px; }
        .image { background-position: 0 -64px; }
       
        #middle-pane { background-color: rgba(60, 70, 80, 0.10); }
        #bottom-pane { background-color: rgba(60, 70, 80, 0.15); }
        #left-pane, #center-pane, #right-pane  { background-color: rgba(60, 70, 80, 0.05); }

        .pane-content {
            padding: 10px 10px;
        }


    </style>
}
     
 <!--Reference the jQuery library. -->
    @*<script src="/Scripts/jquery-1.8.2.min.js" ></script>*@
    <!--Reference the SignalR library. -->
    <script src="/Scripts/jquery.signalR-2.1.2.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="/signalr/hubs"></script>


@section Scripts {


    @*@Scripts.Render("~/bundles/jqueryval")*@
    @Scripts.Render("~/Scripts/jquery.unobtrusive-ajax.min.js")
    
  

    <script type="text/x-kendo-tmpl" id="template">
        <div class="listViewFormat">
            
            #if(Online === "online")
             {#
                <img src="@Url.Content("~/Images/greentick.png")" width="13px" />
            #} else {#
                <img src="@Url.Content("~/Images/redcross.png")" width="13px" />
            # }#
               
            #if(UnreadMessages === "0")
            {#
                #= FirstName# #= LastName# 
            # } else { # 
                <b>#= FirstName# #= LastName# (#= UnreadMessages#) </b>
            # }#

        </div>
    </script>

    
    <script type="text/javascript">
            $("button#btnNewMessage").click(function (e) {
                e.preventDefault();

                var list = $("#StaffList").data("kendoListView");
                var index = list.select().index();
                if (index != -1) {
                    var dataItem = list.dataSource.view()[index];
                    var user = dataItem.UserID;
                    var newMessage = document.getElementById("messageText").value;

                    var url = '@Url.Action("Index","Messaging")';
                    var newCommand = 'Send';

                    $("#divNoUser").hide();
                    $("#divResult").hide();
                    $("#divProcessing").show();

                    $.post(url, { selectedUsers: user, command: newCommand, newMessage: newMessage })
                        .done(function (data) {
                            $('#right-pane').html(data);
                            $("#divProcessing").hide();
                            $("#divResult").show();
                        })

                        .fail(function (jqXHR, status, error) {
                            alert(error + "\r\n" + jqXHR.responseText);
                            $("#divProcessing").hide();
                            $("#divResult").show();
                        });


                }
                else
                    alert("No user selected.");



            });
    </script>

    


}

   

    <script>

        function onUserSelect() {

            var list = $("#StaffList").data("kendoListView");
            var index = list.select().index();

            if (index != -1) {
                var dataItem = list.dataSource.view()[index];
                var user = dataItem.UserID;

                var url = '@Url.Action("Index","Messaging")';
                var newCommand = 'NewSelection';

                $("#divNoUser").hide();
                $("#divResult").hide();
                $("#divProcessing").show();

                $.post(url, { selectedUsers: user, command: newCommand })
                    .done(function (data) {
                        $('#right-pane').html(data);
                        $("#divProcessing").hide();
                        $("#divResult").show();
                    })

                    .fail(function (jqXHR, status, error) {
                        alert(error + "\r\n" + jqXHR.responseText);
                        $("#divProcessing").hide();
                        $("#divResult").show();
                    });

            }
        }

    </script>


   

    <script type="text/javascript">

        $(document).ready(function () {


            // Hide the "busy" Gif at load:
            $("#divProcessing").hide();
            $("#divResult").hide();

            
           
            var messageHub = $.connection.messageHub;
            var userName = "@HttpContext.Current.User.Identity.Name";

            $.connection.hub.qs = { 'userName': userName };
            var popupNotification = $("#popupNotification").data("kendoNotification");

           

           
            messageHub.client.send = function (message) {
                if (message.messageType == "PM") {
                    var list = $("#StaffList").data("kendoListView");
                    var index = list.select().index();
                    onUserSelect();
                    list.dataSource.read();
                    list.select(index);
                    popupNotification.show(message.message);
                }
            };

           
            $.connection.hub.start().done(function () {//when the connection is ready,  
                    
                        popupNotification.show("Server Connection Established");
                    });
                       
        });

        

            $("#vertical").kendoSplitter({
                orientation: "vertical",
                panes: [
                    { collapsible: false, resizable: false}, // Controls parent vertical pane 
                    { collapsible: false, size: "100px" }, //Controls bottom pane
                ]
            });

            $("#horizontal").kendoSplitter({
                panes: [
                    { collapsible: true, size: "20%" },
                    { collapsible: true, size: "70%" }
                ]
            });
        

    </script>



    

