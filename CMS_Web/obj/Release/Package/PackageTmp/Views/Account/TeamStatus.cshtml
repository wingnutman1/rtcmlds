
@{
    ViewBag.Title = "Staff Status";
}

<p class="dataHeader">Team Status</p>

@(Html.Kendo().Notification()
    .Name("popupNotification")
)

<div id="vertical">
    @(Html.Kendo().TreeList<CMS_Web.Models.UserProfile>()
    .Name("treelist")
    .Columns(columns =>
    {
        columns.Add().Field(e => e.LastName).Width("20%");
        columns.Add().Field(e => e.FirstName).Width("15%");
        columns.Add().Field(e => e.PositionDescription).Width("15%");
        columns.Add().Field(e => e.LoggedOn).Width("12%").TemplateId("template").HtmlAttributes(new { style = "text-align: center" });
        columns.Add().Field(e => e.currentLocation).Width("28%");
        columns.Add().Command(c => c.Custom().Name("viewHistory").Click("viewHistory").Text("History"));
        //columns.Add().Title("History").Width("12%").Command(command => command.Custom().Click("viewHistory"));
    })
    .Filterable()
    .Sortable()
    .DataSource(dataSource => dataSource
        .Read(read => read.Action("GetSubordinateList", "Account").Data("currentUserID"))
        .AutoSync(true)
        .ServerOperation(true)
        .Model(m =>
        {
            m.Id(f => f.UserId);
            m.ParentId(f => f.reportsTo);
            m.Expanded(true);
            m.Field(f => f.FirstName);
            m.Field(f => f.LastName);
            m.Field(f => f.reportsTo);
            m.Field(f => f.Inactive);
            m.Field(f => f.currentLocation);
        })
    )
    .Height(540)
    )

</div>

<style scoped>
    #vertical {
        height: auto;
        width: 1000px;
        margin: 0 auto;
    }
</style>

<script type="text/x-kendo-tmpl" id="template">
    <div class="listViewFormat">
        #if(LoggedOn)
        {#        
        <img src="@Url.Content("~/Images/greentick.png")" vertical-align="middle" width="20px" >
        #} else {#
        <img src="@Url.Content("~/Images/redcross.png")" vertical-align="middle" width="20px" >
        # }#
    </div>
</script>

<!--Reference the SignalR library. -->
<script src="/Scripts/jquery.signalR-2.1.2.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="/signalr/hubs"></script>

<script>
    function currentUserID()
    {
        return { UserID: @WebSecurity.CurrentUserId };
    }

    function viewHistory(e)
    {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        window.location.href = "@Url.Action("UserActivity", "Account")?userID=" + dataItem.UserId  + "&returnPage=TeamStatus";
    }

    $(document).ready(function () {


        var messageHub = $.connection.messageHub;
        var userName = "@HttpContext.Current.User.Identity.Name";

        $.connection.hub.qs = { 'userName': userName };
        var popupNotification = $("#popupNotification").data("kendoNotification");

        if ($.connection.hub.state === $.signalR.connectionState.disconnected) {
            $.connection.hub.start().done(function () {//when the connection is ready,

                popupNotification.show("Server Connection Established");
            });
        }

        messageHub.client.send = function (message) {
            if (message.messageType == "PM")
                popupNotification.show(message.message);
        };


    });

</script>   