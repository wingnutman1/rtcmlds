@{
    ViewBag.Title = "My Teams Open Exceptions";
}

<p class="dataHeader">My Teams Open Exceptions</p>


@(Html.Kendo().Notification()
    .Name("popupNotification")
)

<div id="vertical">
    @(Html.Kendo().Grid<CMS_Web.Models.ExceptionDetail>()
                .Name("exceptions")
                .Columns(columns =>
                {
                    columns.Bound(p => p.CreationDate).Title("Date").Format("{0:dd/MM/yyyy hh:mm tt}").Width("15%");
                    columns.Bound(p => p.Description).Title("Description").Width("27%");
                    columns.Template(p => { }).ClientTemplate("#=calcTimeToEscallation(data)#").Title("<div>Time To</div><div>Escallation</div><div>DD:HH:MM</div>").Width("8%");
                    columns.ForeignKey(p => p.relatedStaffID, (System.Collections.IEnumerable)ViewData["UserProfiles"], "UserID", "FullName").Title("<div>Relates</div><div>To</div><div>Staff</div>").Width("10%");
                    columns.ForeignKey(p => p.CurrentActionByStaff, (System.Collections.IEnumerable)ViewData["UserProfiles"], "UserID", "FullName").Title("<div>Current</div><div>Action By</div><div>Staff</div>").Width("10%");
                    columns.Command(command => command.Custom("History").Click("viewHistory")).Width("10%");
                    columns.Command(command => command.Custom("Close").Click("closeException")).Width("10%");
                    columns.Command(command => command.Custom("Escalate").Click("escalateException")).Width("10%");
                })
                .Selectable()
                .Pageable()
                .Sortable()
                .Scrollable()
                .Filterable()
                .HtmlAttributes(new { style = "height:430px; margin-top:20px" })
                .DataSource(dataSource => dataSource.Ajax()
                    .Model(model => model.Id(p => p.ID))
                    .Read(read => read.Action("GetMyTeamsOpenExceptions", "Exceptions").Data("currentUserID"))

                )
                .Resizable(resize => resize.Columns(true))

    )



</div>

<style scoped>
    #vertical {
        height: 600px;
        width: 1000px;
        margin: 0 auto;
    }
</style>

<!--Reference the SignalR library. -->
<script src="/Scripts/jquery.signalR-2.1.2.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="/signalr/hubs"></script>
<script src="/Scripts/moment.js"></script>


<script>

    function calcTimeToEscallation(data)
    {
        var then = moment(data.CurrentActionByDate);
        var now = moment();

        var duration = moment.duration(then.diff(now));
        var days = Math.floor(duration.asDays());
        var hours = Math.floor(duration.asHours()) - (days*24);
        var minutes = Math.floor((duration.asHours() % 1)*60);
        if (duration > 0)
            return zeroPad(days,2) + ":" + zeroPad(hours,2) + ":" + zeroPad(minutes,2);
        else
            return "Escallated";
    }

    function zeroPad(num, places) {
        var zero = places - num.toString().length + 1;
        return Array(+(zero > 0 && zero)).join("0") + num;
    }

    function currentUserID()
    {
        return { UserID: @WebSecurity.CurrentUserId };
    }

    function refreshDataGrid()
    {
        $('#exceptions').data('kendoGrid').dataSource.read();
    }


    function viewHistory(e)
    {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        window.location.href = "@Url.Action("ExceptionHistory", "Exceptions")?exceptionID=" + dataItem.ID  + "&returnPage=MyTeamsOpenExceptions";
    }



    function escalateException(e)
    {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        window.location.href = "@Url.Action("EscalateException", "Exceptions")?ID=" + dataItem.ID  + "&returnPage=MyTeamsOpenExceptions";

    }

    function closeException(e)
    {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        window.location.href = "@Url.Action("CloseException", "Exceptions")?ID=" + dataItem.ID  + "&returnPage=MyTeamsOpenExceptions";


    }

    $(document).ready(function () {


        var messageHub = $.connection.messageHub;
        var userName = "@HttpContext.Current.User.Identity.Name";

        $.connection.hub.qs = { 'userName': userName };
        var popupNotification = $("#popupNotification").data("kendoNotification");

        if ($.connection.hub.state === $.signalR.connectionState.disconnected) {
            $.connection.hub.start().done(function () {//when the connection is ready,

                popupNotification.show("Server Connection Established");
            });
        }

        messageHub.client.send = function (message) {
            if (message.messageType == "PM")
                popupNotification.show(message.message);
        };


    });

</script>

<script id="confirmationTemplate" type="text/x-kendo-template">
    <div class="popupMessage" style="width:600px; margin-top:5px; margin-bottom:5px">
        Confirm Close for the Exception?
    </div>
    <hr />
    <div class="dialog_buttons">
        <input type="button" class="confirm_yes k-button" value="Yes" style="width: 70px" />
        &nbsp;
        <input type="button" class="confirm_no k-button" value="No" style="width: 70px" />
    </div>
</script>

<script id="confirmEscalationTemplate" type="text/x-kendo-template">
    <div class="popupMessage" style="width:600px; margin-top:5px; margin-bottom:5px">
        Are you sure you want to escalate this Exception?
    </div>
    <hr />
    <div class="dialog_buttons">
        <input type="button" class="confirm_esc_yes k-button" value="Yes" style="width: 70px" />
        &nbsp;
        <input type="button" class="confirm_esc_no k-button" value="No" style="width: 70px" />
    </div>
</script>