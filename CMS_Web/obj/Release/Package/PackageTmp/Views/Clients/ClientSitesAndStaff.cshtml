@model CMS_Web.ViewModels.ClientSiteAndStaffViewModel

@{
    ViewBag.Title = "Sites and Staff";
}

<p class="dataHeader">Sites and Staff for Client : <b>@(ViewData["ClientName"])</b></p>

@(Html.Kendo().Notification()
    .Name("popupNotification")
)

@using (Html.BeginForm()) { 
<div id="vertical">

    <span> Sites :
        @(Html.Kendo().MultiSelect()
    .Name("selectedLocations")
    .DataTextField("Name")
    .DataValueField("ID")
    .Placeholder("Select Sites...")
    .BindTo(Model.allLocations)
    .Value(Model.selectedLocations)
        )
    </span>

    <span> Staff :
        @(Html.Kendo().MultiSelect()
        .Name("selectedStaff")
        .DataTextField("FullName")
        .DataValueField("UserId")
        .Placeholder("Select Staff...")
        .BindTo(Model.allStaff)
        .Value(Model.selectedStaff)
        )
    </span>


    <span class="k-button" style="float:left; margin-top:10px; margin-bottom:10px">
        <a onclick = "save()">Save</a>
    </span>

        <span class="k-button" style="float:right; margin-top:10px; margin-bottom:10px">
            @Html.ActionLink("Return to Clients", "Index", "Clients")
        </span>

</div>
}

<style scoped>
    #vertical {
        height: auto;
        width: 1000px;
        margin: 0 auto;
    }
</style>

<!--Reference the SignalR library. -->
<script src="/Scripts/jquery.signalR-2.1.2.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="/signalr/hubs"></script>

<script>

    function clientID()
    {
        var ID = @ViewData["ClientID"];
        return { clientID: ID };
    }

    function save()
    {
        var locationsSelect = $("#selectedLocations").data("kendoMultiSelect");
        var locations = locationsSelect.dataItems();

        var staffSelect = $("#selectedStaff").data("kendoMultiSelect");
        var staff = staffSelect.dataItems();

        

        var count = staff.length;
        var selectedStaff = new Array(count);

        for (var i = 0; i < count; i++)           
            selectedStaff[i] = [staff[i].UserId];            

        count = locations.length;
        var selectedLocations = new Array(count);
        
        for (var i = 0; i < count; i++)
            selectedLocations[i] = [locations[i].ID];            

        var ID = @ViewData["ClientID"];

        $.ajax({
            type: "POST",
            traditional: true,
            url: '@Url.Action("SaveClientSitesAndStaff", "Clients")',
            data: '{"client":"' + ID + '","locations":"' + selectedLocations + '","staff":"' + selectedStaff + '"}',
            contentType: 'application/json',
            success: function(response) {
                window.location =  '@Url.Action("Index","Clients")';
            }
        });

        
    }

    $(document).ready(function () {


        var messageHub = $.connection.messageHub;
        var userName = "@HttpContext.Current.User.Identity.Name";

        $.connection.hub.qs = { 'userName': userName };
        var popupNotification = $("#popupNotification").data("kendoNotification");

        if ($.connection.hub.state === $.signalR.connectionState.disconnected) {
            $.connection.hub.start().done(function () {//when the connection is ready,

                popupNotification.show("Server Connection Established");
            });
        }

        messageHub.client.send = function (message) {
            if (message.messageType == "PM")
                popupNotification.show(message.message);
        };


    });

</script>
