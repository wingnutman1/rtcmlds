@{
    ViewBag.Title = "My Open Incidents";
}

<p class="dataHeader">My Open Incidents</p>


@(Html.Kendo().Notification()
    .Name("popupNotification")
)

<div id="vertical">
    @Html.CheckBox("MyActionOnlyCheckBox", true, new { @onclick = "refreshDataGrid()" })
    <span style="font-size:larger">Only show items I need to action.</span> 
    @(Html.Kendo().Grid<CMS_Web.Models.Incident>()
                .Name("incidents")
                .Columns(columns => {
                    columns.Bound(p => p.Description).Title("Description").Width("50%");
                    columns.ForeignKey(p => p.CurrentManagerID, (System.Collections.IEnumerable)ViewData["UserProfiles"], "UserID", "FullName").Title("Action by").Width("10%");
                    columns.Command(command => command.Custom("History").Click("viewHistory")).Width("10%");
                    columns.Command(command => command.Custom("Upload").Click("uploadFiles")).Width("10%");
                    columns.Command(command => command.Custom("Close").Click("closeIncident")).Width("10%");
                    columns.Command(command => command.Custom("Escalate").Click("escalateIncident")).Width("10%");

                })
                .Selectable()
                .Pageable()
                .Sortable()
                .Scrollable()
                .Filterable()
                .HtmlAttributes(new { style = "height:430px; margin-top:20px" })
                .DataSource(dataSource => dataSource.Ajax()
                    .Model(model => model.Id(p => p.ID))
                    .Read(read => read.Action("GetMyOpenIncidents", "Incidents").Data("currentUserID"))

                )
                .Resizable(resize => resize.Columns(true))

            )          

</div>              

<style scoped>
        #vertical {
            height: 600px;
            width: 1000px;
            margin: 0 auto;
        }

</style>

<!--Reference the SignalR library. -->
<script src="/Scripts/jquery.signalR-2.1.2.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="/signalr/hubs"></script>

<script>

    function refreshDataGrid()
    {
        $('#incidents').data('kendoGrid').dataSource.read();
    }

    function currentUserID()
    {
        var checkedVal=$("#MyActionOnlyCheckBox").is(":checked");
        return { UserID: @WebSecurity.CurrentUserId,
            getOnlyIncidentsIMustAction: checkedVal };
    }

    function viewHistory(e)
    {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        window.location.href = "@Url.Action("IncidentHistory", "incidents")?ID=" + dataItem.ID  + "&returnPage=MyOpenIncidents";
    }

    function uploadFiles(e)
    {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        window.location.href = "@Url.Action("uploadedIncidentFiles", "incidents")?ID=" + dataItem.ID;
    }

    function closeIncident(e)
    {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        var kendoWindow = $("<div />").kendoWindow({
            title: "Confirm Incident Close for Incident : <b>" + dataItem.Description + "</b>",
            resizable: false,
            modal: true
        });

        kendoWindow.data("kendoWindow")
            .content($("#confirmationTemplate").html())
            .center().open();

        kendoWindow
            .find(".confirm_no, .confirm_yes,.delete-cancel")
                .click(function() {
                    if ($(this).hasClass("confirm_yes")) {

                        window.location.href = "@Url.Action("closeIncident", "incidents")?ID=" + dataItem.ID  + "&returnPage=MyOpenIncidents";

                    }

                    kendoWindow.data("kendoWindow").close();
                })
                .end()


    }

    function escalateIncident(e)
    {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        var kendoWindow = $("<div />").kendoWindow({
            title: "Confirm Incident Escalate for Incident : <b>" + dataItem.Description + "</b>",
            resizable: false,
            modal: true
        });

        kendoWindow.data("kendoWindow")
            .content($("#confirmEscalationTemplate").html())
            .center().open();

        kendoWindow
            .find(".confirm_esc_no, .confirm_esc_yes,.delete-cancel")
                .click(function() {
                    if ($(this).hasClass("confirm_esc_yes")) {

                        e.preventDefault();
                        $.post("@Url.Action("escalateIncident", "incidents")", { ID : dataItem.ID } ,function(data){
                            //alert(data);
                        }
                    )}
                    kendoWindow.data("kendoWindow").close();
                })
                .end()


    }

    $(document).ready(function () {


        var messageHub = $.connection.messageHub;
        var userName = "@HttpContext.Current.User.Identity.Name";

        $.connection.hub.qs = { 'userName': userName };
        var popupNotification = $("#popupNotification").data("kendoNotification");

        if ($.connection.hub.state === $.signalR.connectionState.disconnected) {
            $.connection.hub.start().done(function () {//when the connection is ready,

                popupNotification.show("Server Connection Established");
            });
        }

        messageHub.client.send = function (message) {
            if (message.messageType == "PM")
                popupNotification.show(message.message);
        };


    });


    </script>

<script id="confirmationTemplate" type="text/x-kendo-template">
    <div class="popupMessage" style="width:400px">
        Please ensure the template files have been completed and uploaded.
    </div>
    <br>
    <hr />
    <div class="dialog_buttons">
        <input type="button" class="confirm_yes k-button" value="Yes" style="width: 70px" />
        &nbsp;
        <input type="button" class="confirm_no k-button" value="No" style="width: 70px" />
    </div>
</script>

<script id="confirmEscalationTemplate" type="text/x-kendo-template">
    <div class="popupMessage" style="width:400px">
        Are you sure you want to escalate this Incident?
    </div>
    <br>
    <hr />
    <div class="dialog_buttons">
        <input type="button" class="confirm_esc_yes k-button" value="Yes" style="width: 70px" />
        &nbsp;
        <input type="button" class="confirm_esc_no k-button" value="No" style="width: 70px" />
    </div>
</script>