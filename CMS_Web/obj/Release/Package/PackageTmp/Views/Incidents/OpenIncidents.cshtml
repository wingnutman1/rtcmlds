@{
    ViewBag.Title = "OpenIncident";
}

<p class="dataHeader">Open Incidents</p>



@(Html.Kendo().Notification()
    .Name("popupNotification")
)

<div id="vertical">

    @Html.ValidationSummary()

    @(Html.Kendo().Grid<CMS_Web.Models.Incident>()
                .Name("Incident")
                .Columns(columns =>
                {
                    columns.Bound(p => p.incidentDate).Title("Occured On").Width("7%").Format("{0:dd/MM/yyyy hh:mm}");
                    columns.Bound(p => p.reportedDate).Title("Reported On").Width("7%").Format("{0:dd/MM/yyyy hh:mm}");
                    columns.Bound(p => p.Description).Title("Description").Width("15%");
                    columns.ForeignKey(p => p.UserProfileID, (System.Collections.IEnumerable)ViewData["UserProfiles"], "UserID", "FullName").Title("Staff").Width("6%");
                    columns.ForeignKey(p => p.LocationID, (System.Collections.IEnumerable)ViewData["Locations"], "ID", "Name").Title("Location").Width("6%");
                    columns.ForeignKey(p => p.ClientID, (System.Collections.IEnumerable)ViewData["Clients"], "ID", "FullName").Title("Client").Width("6%");
                    columns.Command(command => command.Custom("History").Click("viewHistory")).Width("12%");

                })
                .Selectable()
                .Pageable()
                .Sortable()
                .Scrollable()
                .Filterable()
                .HtmlAttributes(new { style = "height:430px;" })
                .DataSource(dataSource => dataSource.Ajax()
                    .Model(model => model.Id(p => p.ID))
                    .Read(read => read.Action("GetOpenIncidents", "Incidents"))
                )
                .Resizable(resize => resize.Columns(true))

    )

</div>

<style scoped>
    #vertical {
        height: 600px;
        width: 1000px;
        margin: 0 auto;
    }
</style>

<!--Reference the SignalR library. -->
<script src="/Scripts/jquery.signalR-2.1.2.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="/signalr/hubs"></script>

<script>
    function viewHistory(e)
    {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        window.location.href = "@Url.Action("IncidentHistory", "incidents")?ID=" + dataItem.ID  + "&returnPage=OpenIncidents";
    }

    $(document).ready(function () {


        var messageHub = $.connection.messageHub;
        var userName = "@HttpContext.Current.User.Identity.Name";

        $.connection.hub.qs = { 'userName': userName };
        var popupNotification = $("#popupNotification").data("kendoNotification");

        if ($.connection.hub.state === $.signalR.connectionState.disconnected) {
            $.connection.hub.start().done(function () {//when the connection is ready,

                popupNotification.show("Server Connection Established");
            });
        }

        messageHub.client.send = function (message) {
            if (message.messageType == "PM")
                popupNotification.show(message.message);
        };


    });

</script>